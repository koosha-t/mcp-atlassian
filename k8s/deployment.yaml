apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcp-atlassian
  namespace: ${NAMESPACE}
  labels:
    app: mcp-atlassian
    component: mcp-server
spec:
  replicas: ${REPLICAS}
  selector:
    matchLabels:
      app: mcp-atlassian
  template:
    metadata:
      labels:
        app: mcp-atlassian
        component: mcp-server
    spec:
      containers:
      - name: mcp-atlassian
        image: ghcr.io/sooperset/mcp-atlassian:${IMAGE_TAG}
        imagePullPolicy: ${IMAGE_PULL_POLICY}
        args:
          - "--transport"
          - "streamable-http"
          - "--port"
          - "8000"
          - "--host"
          - "0.0.0.0"
        ports:
        - name: http
          containerPort: 8000
          protocol: TCP
        env:
        # Non-sensitive configuration from ConfigMap
        - name: JIRA_URL
          valueFrom:
            configMapKeyRef:
              name: mcp-atlassian-config
              key: jira-url
        - name: CONFLUENCE_URL
          valueFrom:
            configMapKeyRef:
              name: mcp-atlassian-config
              key: confluence-url
        - name: TRANSPORT
          valueFrom:
            configMapKeyRef:
              name: mcp-atlassian-config
              key: transport
        - name: PORT
          valueFrom:
            configMapKeyRef:
              name: mcp-atlassian-config
              key: port
        - name: HOST
          valueFrom:
            configMapKeyRef:
              name: mcp-atlassian-config
              key: host
        - name: MCP_VERBOSE
          valueFrom:
            configMapKeyRef:
              name: mcp-atlassian-config
              key: mcp-verbose
              optional: true
        # Sensitive credentials from Secret
        - name: JIRA_PERSONAL_TOKEN
          valueFrom:
            secretKeyRef:
              name: mcp-atlassian-secrets
              key: jira-personal-token
        - name: CONFLUENCE_PERSONAL_TOKEN
          valueFrom:
            secretKeyRef:
              name: mcp-atlassian-secrets
              key: confluence-personal-token
        resources:
          requests:
            memory: "${MEMORY_REQUEST}"
            cpu: "${CPU_REQUEST}"
          limits:
            memory: "${MEMORY_LIMIT}"
            cpu: "${CPU_LIMIT}"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
              - ALL
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
